<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>研究データ管理システム</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        .loading {
            display: none;
        }
        .loading.show {
            display: block;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- ヘッダー -->
    <header class="gradient-bg text-white shadow-lg">
        <div class="container mx-auto px-4 py-6">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-3xl font-bold">研究データ管理システム</h1>
                    <p class="text-gray-200 mt-1">Google Drive連携 & AI研究相談</p>
                </div>
                <div class="flex items-center space-x-4">
                    <div id="system-status" class="flex items-center space-x-2">
                        <span class="text-sm">システム状態:</span>
                        <div class="flex space-x-2">
                            <div id="google-drive-status" class="w-3 h-3 rounded-full bg-gray-400"></div>
                            <div id="database-status" class="w-3 h-3 rounded-full bg-green-400"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- メインコンテンツ -->
    <main class="container mx-auto px-4 py-8">
        <!-- 統計情報 -->
        <div class="grid md:grid-cols-3 gap-6 mb-8">
            <div class="bg-white rounded-lg shadow-md p-6 card-hover transition-all duration-200">
                <div class="flex items-center">
                    <div class="bg-blue-100 p-3 rounded-full">
                        <i class="fas fa-file-alt text-blue-600 text-xl"></i>
                    </div>
                    <div class="ml-4">
                        <h3 class="text-lg font-semibold text-gray-700">論文</h3>
                        <p class="text-2xl font-bold text-blue-600" id="papers-count">{{ stats.papers }}</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow-md p-6 card-hover transition-all duration-200">
                <div class="flex items-center">
                    <div class="bg-green-100 p-3 rounded-full">
                        <i class="fas fa-image text-green-600 text-xl"></i>
                    </div>
                    <div class="ml-4">
                        <h3 class="text-lg font-semibold text-gray-700">ポスター</h3>
                        <p class="text-2xl font-bold text-green-600" id="posters-count">{{ stats.posters }}</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow-md p-6 card-hover transition-all duration-200">
                <div class="flex items-center">
                    <div class="bg-purple-100 p-3 rounded-full">
                        <i class="fas fa-database text-purple-600 text-xl"></i>
                    </div>
                    <div class="ml-4">
                        <h3 class="text-lg font-semibold text-gray-700">データセット</h3>
                        <p class="text-2xl font-bold text-purple-600" id="datasets-count">{{ stats.datasets }}</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 主要機能 -->
        <div class="grid lg:grid-cols-2 gap-8">
            <!-- Google Drive同期 -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                    <i class="fab fa-google-drive text-blue-500 mr-2"></i>
                    Google Drive同期
                </h2>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">同期対象</label>
                        <select id="sync-folder-type" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="all">すべて</option>
                            <option value="papers">論文</option>
                            <option value="posters">ポスター</option>
                            <option value="datasets">データセット</option>
                        </select>
                    </div>
                    
                    <button id="sync-button" class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 transition-colors duration-200">
                        <span id="sync-text">同期開始</span>
                        <div id="sync-loading" class="loading">
                            <i class="fas fa-spinner fa-spin mr-2"></i>同期中...
                        </div>
                    </button>
                    
                    <div id="sync-result" class="hidden p-3 rounded-md"></div>
                </div>
                
                <!-- Google Drive状態 -->
                <div id="drive-status" class="mt-4 p-3 bg-gray-50 rounded-md">
                    <p class="text-sm text-gray-600">Google Drive状態を確認中...</p>
                </div>
            </div>

            <!-- AI研究相談チャット -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                    <i class="fas fa-robot text-green-500 mr-2"></i>
                    AI研究相談チャット
                    <span id="chat-status" class="ml-auto text-sm text-gray-500"></span>
                </h2>
                
                <!-- チャット設定 -->
                <div class="mb-4 p-3 bg-gray-50 rounded-md">
                    <label class="block text-sm font-medium text-gray-700 mb-2">相談タイプ</label>
                    <select id="consultation-type" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-500">
                        <option value="general">一般的な研究相談</option>
                        <option value="database">データベース検索・相談</option>
                        <option value="planning">研究計画相談</option>
                    </select>
                </div>
                
                <!-- チャット履歴エリア -->
                <div id="chat-history" class="h-96 border border-gray-200 rounded-md p-4 mb-4 overflow-y-auto bg-gray-50">
                    <div id="chat-welcome" class="text-center text-gray-500 py-8">
                        <i class="fas fa-comment-alt text-4xl mb-2"></i>
                        <p class="font-medium">研究について何でもお聞きください！</p>
                        <p class="text-sm mt-1">データベース内の論文・ポスター・データセットを参照して回答します</p>
                        <div class="mt-4 text-xs text-gray-400">
                            現在のデータ: 論文<span id="chat-papers-count">{{ stats.papers }}</span>件, 
                            ポスター<span id="chat-posters-count">{{ stats.posters }}</span>件, 
                            データセット<span id="chat-datasets-count">{{ stats.datasets }}</span>件
                        </div>
                    </div>
                </div>
                
                <!-- 入力エリア -->
                <div class="space-y-3">
                    <div class="flex space-x-2">
                        <input type="text" 
                               id="chat-input" 
                               class="flex-1 border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-500" 
                               placeholder="研究について質問してください..." 
                               onkeypress="handleChatKeyPress(event)">
                        <button id="chat-send-button" 
                                onclick="sendChatMessage()" 
                                class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 transition-colors duration-200 flex items-center disabled:bg-gray-400">
                            <i class="fas fa-paper-plane mr-1"></i>
                            送信
                        </button>
                    </div>
                    
                    <!-- クイックアクション -->
                    <div class="flex flex-wrap gap-2">
                        <button onclick="quickQuestion('どんなデータセットがありますか？')" class="text-xs bg-blue-100 text-blue-700 px-3 py-1 rounded-full hover:bg-blue-200 transition-colors">
                            データセット一覧
                        </button>
                        <button onclick="quickQuestion('ESGに関連する研究はありますか？')" class="text-xs bg-green-100 text-green-700 px-3 py-1 rounded-full hover:bg-green-200 transition-colors">
                            ESG研究
                        </button>
                        <button onclick="quickQuestion('機械学習の研究について相談したい')" class="text-xs bg-purple-100 text-purple-700 px-3 py-1 rounded-full hover:bg-purple-200 transition-colors">
                            機械学習研究
                        </button>
                        <button onclick="showDatabaseOverview()" class="text-xs bg-yellow-100 text-yellow-700 px-3 py-1 rounded-full hover:bg-yellow-200 transition-colors">
                            <i class="fas fa-database mr-1"></i>DB概要
                        </button>
                        <button onclick="clearChat()" class="text-xs bg-gray-100 text-gray-700 px-3 py-1 rounded-full hover:bg-gray-200 transition-colors">
                            <i class="fas fa-trash mr-1"></i>履歴クリア
                        </button>
                    </div>
                </div>
            </div>

        </div>

        <!-- 詳細データダッシュボード -->
        <div class="mt-8 bg-white rounded-lg shadow-md p-6">
            <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                <i class="fas fa-chart-bar text-indigo-500 mr-2"></i>
                詳細データダッシュボード
                <button id="refresh-charts-btn" class="ml-auto text-sm bg-indigo-100 text-indigo-600 px-3 py-1 rounded hover:bg-indigo-200 transition-colors">
                    <i class="fas fa-sync-alt mr-1"></i>更新
                </button>
            </h2>
            
            <!-- チャート表示エリア -->
            <div class="grid lg:grid-cols-2 gap-6">
                <!-- 統計サマリーチャート -->
                <div class="bg-gray-50 p-4 rounded-lg">
                    <h3 class="text-lg font-semibold text-gray-700 mb-3 text-center">
                        データタイプ別件数
                    </h3>
                    <div style="position: relative; height: 250px;">
                        <canvas id="summaryChart"></canvas>
                    </div>
                </div>
                
                <!-- カテゴリ分布チャート -->
                <div class="bg-gray-50 p-4 rounded-lg">
                    <h3 class="text-lg font-semibold text-gray-700 mb-3 text-center">
                        データセットカテゴリ分布
                    </h3>
                    <div style="position: relative; height: 250px;">
                        <canvas id="categoryChart"></canvas>
                    </div>
                </div>
            </div>
            
            <!-- 詳細統計 -->
            <div class="mt-6 grid md:grid-cols-4 gap-4">
                <div class="bg-blue-50 p-4 rounded-lg text-center">
                    <div class="text-2xl font-bold text-blue-600" id="chart-total-files">-</div>
                    <div class="text-sm text-blue-700">総ファイル数</div>
                </div>
                <div class="bg-green-50 p-4 rounded-lg text-center">
                    <div class="text-2xl font-bold text-green-600" id="chart-total-size">-</div>
                    <div class="text-sm text-green-700">総サイズ (MB)</div>
                </div>
                <div class="bg-purple-50 p-4 rounded-lg text-center">
                    <div class="text-2xl font-bold text-purple-600" id="chart-avg-size">-</div>
                    <div class="text-sm text-purple-700">平均サイズ (MB)</div>
                </div>
                <div class="bg-orange-50 p-4 rounded-lg text-center">
                    <div class="text-2xl font-bold text-orange-600" id="chart-last-updated">-</div>
                    <div class="text-sm text-orange-700">最終更新</div>
                </div>
            </div>
            
            <!-- チャート制御 -->
            <div class="mt-4 flex items-center justify-between text-sm text-gray-600">
                <div>
                    <label class="flex items-center">
                        <input type="checkbox" id="auto-refresh-charts" class="mr-2" checked>
                        <span>30秒ごとに自動更新</span>
                    </label>
                </div>
                <div id="chart-status" class="text-xs">
                    <!-- 動的に更新される状態表示 -->
                </div>
            </div>
        </div>

        <!-- 検索機能 -->
        <div class="mt-8 bg-white rounded-lg shadow-md p-6">
            <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                <i class="fas fa-search text-blue-500 mr-2"></i>
                研究データ検索
            </h2>
            
            <div class="flex gap-4 mb-4">
                <div class="flex-1">
                    <input type="text" id="search-query" 
                           class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" 
                           placeholder="キーワードで検索...">
                </div>
                <div>
                    <select id="search-type" class="border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="all">すべて</option>
                        <option value="papers">論文</option>
                        <option value="posters">ポスター</option>
                        <option value="datasets">データセット</option>
                    </select>
                </div>
                <button id="search-button" class="bg-blue-600 text-white px-6 py-2 rounded-md hover:bg-blue-700 transition-colors duration-200">
                    検索
                </button>
            </div>
            
            <div id="search-results" class="space-y-3">
                <!-- 検索結果がここに表示されます -->
            </div>
        </div>

    </main>

    <!-- JavaScript -->
    <script>
        // システム状態の更新
        async function updateSystemStatus() {
            try {
                const response = await fetch('/api/status');
                const status = await response.json();
                
                document.getElementById('google-drive-status').className = 
                    `w-3 h-3 rounded-full ${status.google_drive ? 'bg-green-400' : 'bg-red-400'}`;
                
                // 統計情報更新
                document.getElementById('papers-count').textContent = status.stats.papers;
                document.getElementById('posters-count').textContent = status.stats.posters;
                document.getElementById('datasets-count').textContent = status.stats.datasets;
                
                // チャット用統計も更新
                const chatPapersCount = document.getElementById('chat-papers-count');
                const chatPostersCount = document.getElementById('chat-posters-count');
                const chatDatasetsCount = document.getElementById('chat-datasets-count');
                if (chatPapersCount) chatPapersCount.textContent = status.stats.papers;
                if (chatPostersCount) chatPostersCount.textContent = status.stats.posters;
                if (chatDatasetsCount) chatDatasetsCount.textContent = status.stats.datasets;
                
            } catch (error) {
                console.error('システム状態取得エラー:', error);
            }
        }

        // Google Drive状態の更新
        async function updateGoogleDriveStatus() {
            try {
                const response = await fetch('/api/google-drive/status');
                const status = await response.json();
                const statusDiv = document.getElementById('drive-status');
                
                if (status.enabled) {
                    if (status.storage) {
                        statusDiv.innerHTML = `
                            <p class="text-sm text-green-600">
                                <i class="fas fa-check-circle mr-1"></i>
                                Google Drive接続済み - 使用量: ${status.storage.usage_gb.toFixed(2)}GB / ${status.storage.limit_gb.toFixed(2)}GB (${status.storage.usage_percent.toFixed(1)}%)
                            </p>
                            <p class="text-xs text-gray-500 mt-1">
                                フォルダ: ${status.folders.join(', ')} (${status.file_count}ファイル)
                            </p>
                        `;
                    } else {
                        statusDiv.innerHTML = '<p class="text-sm text-green-600"><i class="fas fa-check-circle mr-1"></i>Google Drive接続済み</p>';
                    }
                } else {
                    statusDiv.innerHTML = '<p class="text-sm text-red-600"><i class="fas fa-times-circle mr-1"></i>Google Drive未接続</p>';
                }
            } catch (error) {
                console.error('Google Drive状態取得エラー:', error);
                document.getElementById('drive-status').innerHTML = '<p class="text-sm text-red-600"><i class="fas fa-exclamation-triangle mr-1"></i>状態取得エラー</p>';
            }
        }

        // Google Drive同期
        async function syncGoogleDrive() {
            const button = document.getElementById('sync-button');
            const text = document.getElementById('sync-text');
            const loading = document.getElementById('sync-loading');
            const result = document.getElementById('sync-result');
            const folderType = document.getElementById('sync-folder-type').value;
            
            // UI更新
            button.disabled = true;
            text.style.display = 'none';
            loading.classList.add('show');
            result.classList.add('hidden');
            
            try {
                const response = await fetch('/api/sync/google-drive', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ folder_type: folderType })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    result.className = 'p-3 rounded-md bg-green-100 border border-green-300 text-green-700';
                    result.innerHTML = `<i class="fas fa-check mr-2"></i>${data.message}`;
                } else {
                    result.className = 'p-3 rounded-md bg-red-100 border border-red-300 text-red-700';
                    result.innerHTML = `<i class="fas fa-times mr-2"></i>同期に失敗しました`;
                }
                
                result.classList.remove('hidden');
                
                // 統計情報更新
                setTimeout(updateSystemStatus, 2000);
                
            } catch (error) {
                console.error('同期エラー:', error);
                result.className = 'p-3 rounded-md bg-red-100 border border-red-300 text-red-700';
                result.innerHTML = `<i class="fas fa-times mr-2"></i>同期エラー: ${error.message}`;
                result.classList.remove('hidden');
            } finally {
                // UI復元
                button.disabled = false;
                text.style.display = 'inline';
                loading.classList.remove('show');
            }
        }

        // 検索機能
        async function searchData() {
            const query = document.getElementById('search-query').value;
            const searchType = document.getElementById('search-type').value;
            const resultsDiv = document.getElementById('search-results');
            
            if (!query.trim()) {
                resultsDiv.innerHTML = '<p class="text-gray-500">検索キーワードを入力してください</p>';
                return;
            }
            
            resultsDiv.innerHTML = '<p class="text-gray-500"><i class="fas fa-spinner fa-spin mr-2"></i>検索中...</p>';
            
            try {
                const response = await fetch('/api/search', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ query, search_type: searchType })
                });
                
                const data = await response.json();
                
                if (data.results.length === 0) {
                    resultsDiv.innerHTML = '<p class="text-gray-500">検索結果が見つかりませんでした</p>';
                    return;
                }
                
                let html = `<p class="text-gray-600 mb-3">${data.total}件の結果が見つかりました</p>`;
                
                data.results.forEach(item => {
                    const typeIcon = {
                        'paper': 'fas fa-file-alt text-blue-500',
                        'poster': 'fas fa-image text-green-500',
                        'dataset': 'fas fa-database text-purple-500'
                    }[item.type];
                    
                    const typeLabel = {
                        'paper': '論文',
                        'poster': 'ポスター',
                        'dataset': 'データセット'
                    }[item.type];
                    
                    html += `
                        <div class="border border-gray-200 rounded-md p-4 hover:bg-gray-50">
                            <div class="flex items-start justify-between">
                                <div class="flex-1">
                                    <div class="flex items-center mb-2">
                                        <i class="${typeIcon} mr-2"></i>
                                        <span class="text-sm text-gray-500">${typeLabel}</span>
                                    </div>
                                    <h3 class="font-semibold text-gray-800">${item.title || item.name || item.file_name}</h3>
                                    ${item.authors ? `<p class="text-sm text-gray-600 mt-1">著者: ${item.authors}</p>` : ''}
                                    ${item.abstract || item.description ? `<p class="text-sm text-gray-600 mt-1">${(item.abstract || item.description).substring(0, 100)}...</p>` : ''}
                                </div>
                                <div class="text-right text-sm text-gray-500">
                                    ${item.file_size ? `${(item.file_size / 1024).toFixed(1)}KB` : ''}
                                    ${item.file_count ? `${item.file_count}ファイル` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                resultsDiv.innerHTML = html;
                
            } catch (error) {
                console.error('検索エラー:', error);
                resultsDiv.innerHTML = '<p class="text-red-500"><i class="fas fa-times mr-2"></i>検索エラーが発生しました</p>';
            }
        }

        // チャット機能
        let chatHistory = [];
        let isChatting = false;

        // Enterキーでメッセージ送信
        function handleChatKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendChatMessage();
            }
        }

        // クイック質問
        function quickQuestion(question) {
            document.getElementById('chat-input').value = question;
            sendChatMessage();
        }

        // チャット履歴クリア
        function clearChat() {
            chatHistory = [];
            const historyDiv = document.getElementById('chat-history');
            historyDiv.innerHTML = `
                <div id="chat-welcome" class="text-center text-gray-500 py-8">
                    <i class="fas fa-comment-alt text-4xl mb-2"></i>
                    <p class="font-medium">研究について何でもお聞きください！</p>
                    <p class="text-sm mt-1">データベース内の論文・ポスター・データセットを参照して回答します</p>
                    <div class="mt-4 text-xs text-gray-400">
                        現在のデータ: 論文<span id="chat-papers-count">${document.getElementById('papers-count').textContent}</span>件, 
                        ポスター<span id="chat-posters-count">${document.getElementById('posters-count').textContent}</span>件, 
                        データセット<span id="chat-datasets-count">${document.getElementById('datasets-count').textContent}</span>件
                    </div>
                </div>
            `;
        }

        // チャットメッセージ送信
        async function sendChatMessage() {
            if (isChatting) return;
            
            const input = document.getElementById('chat-input');
            const sendButton = document.getElementById('chat-send-button');
            const historyDiv = document.getElementById('chat-history');
            const statusSpan = document.getElementById('chat-status');
            const consultationType = document.getElementById('consultation-type').value;
            
            const message = input.value.trim();
            if (!message) return;
            
            // ウェルカムメッセージを削除
            const welcome = document.getElementById('chat-welcome');
            if (welcome) {
                welcome.remove();
            }
            
            // ユーザーメッセージを追加
            addChatMessage('user', message);
            
            // UI状態更新
            input.value = '';
            input.disabled = true;
            sendButton.disabled = true;
            isChatting = true;
            statusSpan.textContent = '応答中...';
            
            // 「入力中」インジケーター表示
            const typingDiv = document.createElement('div');
            typingDiv.className = 'flex items-start space-x-3 mb-4';
            typingDiv.id = 'typing-indicator';
            typingDiv.innerHTML = `
                <div class="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center">
                    <i class="fas fa-robot text-green-600 text-sm"></i>
                </div>
                <div class="flex-1 bg-white border border-gray-200 rounded-lg p-3 shadow-sm">
                    <div class="flex space-x-1">
                        <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce"></div>
                        <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
                        <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                    </div>
                </div>
            `;
            historyDiv.appendChild(typingDiv);
            historyDiv.scrollTop = historyDiv.scrollHeight;
            
            try {
                const response = await fetch('/api/consultation', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        query: message, 
                        consultation_type: consultationType 
                    })
                });
                
                const data = await response.json();
                
                // 入力中インジケーター削除
                document.getElementById('typing-indicator').remove();
                
                // AIレスポンスを追加
                addChatMessage('ai', data.advice, data);
                
            } catch (error) {
                console.error('チャットエラー:', error);
                
                // 入力中インジケーター削除
                const typing = document.getElementById('typing-indicator');
                if (typing) typing.remove();
                
                addChatMessage('ai', '申し訳ございません。エラーが発生しました。もう一度お試しください。');
            } finally {
                // UI状態復元
                input.disabled = false;
                sendButton.disabled = false;
                isChatting = false;
                statusSpan.textContent = '';
                input.focus();
            }
        }

        // チャットメッセージ追加
        function addChatMessage(sender, message, data = null) {
            const historyDiv = document.getElementById('chat-history');
            const timestamp = new Date().toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
            
            const messageDiv = document.createElement('div');
            messageDiv.className = 'flex items-start space-x-3 mb-4';
            
            if (sender === 'user') {
                messageDiv.innerHTML = `
                    <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center">
                        <i class="fas fa-user text-blue-600 text-sm"></i>
                    </div>
                    <div class="flex-1 bg-blue-50 border border-blue-200 rounded-lg p-3">
                        <div class="text-blue-900">${escapeHtml(message)}</div>
                        <div class="text-xs text-blue-600 mt-1">${timestamp}</div>
                    </div>
                `;
            } else {
                let responseHtml = `
                    <div class="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center">
                        <i class="fas fa-robot text-green-600 text-sm"></i>
                    </div>
                    <div class="flex-1 bg-white border border-gray-200 rounded-lg p-3 shadow-sm">
                        <div class="text-gray-900 mb-2">${formatResponse(message)}</div>
                `;
                
                // 関連文書があれば表示
                if (data && data.related_documents && data.related_documents.length > 0) {
                    responseHtml += `
                        <div class="mt-3 p-2 bg-gray-50 rounded border">
                            <div class="text-xs font-medium text-gray-700 mb-1">関連文書 (${data.related_documents.length}件)</div>
                            <div class="space-y-1">
                                ${data.related_documents.slice(0, 3).map(doc => `
                                    <div class="text-xs text-gray-600">
                                        <i class="fas fa-file-alt mr-1"></i>${doc.title || doc.file_name}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }
                
                // 関連データセットがあれば表示
                if (data && data.relevant_datasets && data.relevant_datasets.length > 0) {
                    responseHtml += `
                        <div class="mt-3 p-2 bg-blue-50 rounded border">
                            <div class="text-xs font-medium text-blue-700 mb-1">関連データセット (${data.relevant_datasets.length}件)</div>
                            <div class="space-y-1">
                                ${data.relevant_datasets.slice(0, 3).map(ds => `
                                    <div class="text-xs text-blue-600">
                                        <i class="fas fa-database mr-1"></i>${ds.name} (${ds.file_count}ファイル)
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }
                
                responseHtml += `
                        <div class="text-xs text-gray-500 mt-2">${timestamp}</div>
                    </div>
                `;
                
                messageDiv.innerHTML = responseHtml;
            }
            
            historyDiv.appendChild(messageDiv);
            historyDiv.scrollTop = historyDiv.scrollHeight;
            
            // チャット履歴に保存
            chatHistory.push({ sender, message, timestamp, data });
        }

        // HTMLエスケープ
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // レスポンス整形
        function formatResponse(text) {
            // 改行を<br>に変換
            return escapeHtml(text).replace(/\n/g, '<br>');
        }

        // データベース概要表示
        async function showDatabaseOverview() {
            try {
                const response = await fetch('/api/database/summary');
                if (response.ok) {
                    const data = await response.json();
                    
                    // ウェルカムメッセージを削除
                    const welcome = document.getElementById('chat-welcome');
                    if (welcome) {
                        welcome.remove();
                    }
                    
                    // 概要メッセージを作成
                    let overviewHtml = `
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-3">
                            <h3 class="font-bold text-blue-800 mb-3 flex items-center">
                                <i class="fas fa-database mr-2"></i>データベース概要
                            </h3>
                            
                            <div class="grid grid-cols-3 gap-4 mb-4">
                                <div class="text-center">
                                    <div class="text-2xl font-bold text-blue-600">${data.totals.papers}</div>
                                    <div class="text-sm text-blue-700">論文</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-2xl font-bold text-green-600">${data.totals.posters}</div>
                                    <div class="text-sm text-green-700">ポスター</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-2xl font-bold text-purple-600">${data.totals.datasets}</div>
                                    <div class="text-sm text-purple-700">データセット</div>
                                </div>
                            </div>
                    `;
                    
                    if (data.datasets.items.length > 0) {
                        overviewHtml += `
                            <div class="mt-4">
                                <h4 class="font-semibold text-gray-700 mb-2">主要データセット</h4>
                                <div class="space-y-2">
                        `;
                        
                        data.datasets.items.forEach(ds => {
                            overviewHtml += `
                                <div class="bg-white border rounded p-2">
                                    <div class="flex justify-between items-center">
                                        <span class="font-medium text-gray-800">${ds.name}</span>
                                        <span class="text-sm text-gray-500">${ds.file_count}ファイル, ${ds.total_size_mb}MB</span>
                                    </div>
                                </div>
                            `;
                        });
                        
                        overviewHtml += `
                                </div>
                            </div>
                        `;
                    }
                    
                    overviewHtml += `
                            <div class="mt-4 text-sm text-blue-600">
                                詳細な情報については「どんなデータセットがありますか？」などの質問をお気軽にどうぞ！
                            </div>
                        </div>
                    `;
                    
                    const historyDiv = document.getElementById('chat-history');
                    historyDiv.innerHTML = overviewHtml;
                    
                } else {
                    console.error('データベース概要取得エラー:', response.status);
                }
            } catch (error) {
                console.error('データベース概要取得エラー:', error);
            }
        }

        // イベントリスナー設定
        document.getElementById('sync-button').addEventListener('click', syncGoogleDrive);
        document.getElementById('search-button').addEventListener('click', searchData);
        
        // Enterキーで検索
        document.getElementById('search-query').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchData();
            }
        });


        // チャート関連の変数
        let summaryChart = null;
        let categoryChart = null;
        let autoRefreshInterval = null;

        // チャートの初期化
        function initializeCharts() {
            // 統計サマリーチャート（棒グラフ）- 固定高さで修正
            const summaryCtx = document.getElementById('summaryChart').getContext('2d');
            summaryChart = new Chart(summaryCtx, {
                type: 'bar',
                data: {
                    labels: ['論文', 'ポスター', 'データセット'],
                    datasets: [{
                        label: '件数',
                        data: [0, 0, 0],
                        backgroundColor: [
                            'rgba(59, 130, 246, 0.8)',  // blue
                            'rgba(16, 185, 129, 0.8)',  // green
                            'rgba(139, 92, 246, 0.8)'   // purple
                        ],
                        borderColor: [
                            'rgba(59, 130, 246, 1)',
                            'rgba(16, 185, 129, 1)',
                            'rgba(139, 92, 246, 1)'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 10,  // 最大値を固定
                            ticks: {
                                stepSize: 1
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });

            // カテゴリ分布チャート（ドーナツグラフ）
            const categoryCtx = document.getElementById('categoryChart').getContext('2d');
            categoryChart = new Chart(categoryCtx, {
                type: 'doughnut',
                data: {
                    labels: ['機械学習', 'ESG', 'データ可視化', 'その他'],
                    datasets: [{
                        data: [0, 0, 0, 0],
                        backgroundColor: [
                            'rgba(245, 158, 11, 0.8)',  // yellow
                            'rgba(34, 197, 94, 0.8)',   // green
                            'rgba(168, 85, 247, 0.8)',  // purple
                            'rgba(156, 163, 175, 0.8)'  // gray
                        ],
                        borderColor: [
                            'rgba(245, 158, 11, 1)',
                            'rgba(34, 197, 94, 1)',
                            'rgba(168, 85, 247, 1)',
                            'rgba(156, 163, 175, 1)'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 10,
                                font: {
                                    size: 10
                                }
                            }
                        }
                    }
                }
            });

        }

        // チャートデータの更新
        async function updateCharts() {
            const statusDiv = document.getElementById('chart-status');
            
            if (statusDiv) statusDiv.textContent = '更新中...';
            
            try {
                const response = await fetch('/api/looker-studio/status');
                const data = await response.json();
                
                if (data.last_stats) {
                    const stats = data.last_stats;
                    const totalSizeMB = stats.total_size_gb * 1024; // GBをMBに変換
                    
                    // 統計サマリーチャートの更新
                    if (summaryChart) {
                        summaryChart.data.datasets[0].data = [
                            stats.total_papers,
                            stats.total_posters,
                            stats.total_datasets
                        ];
                        // Y軸の最大値を動的に調整
                        const maxValue = Math.max(stats.total_papers, stats.total_posters, stats.total_datasets);
                        summaryChart.options.scales.y.max = Math.max(10, maxValue + 2);
                        summaryChart.update();
                    }
                    
                    // カテゴリ分布チャートの更新
                    if (categoryChart) {
                        categoryChart.data.datasets[0].data = [
                            stats.category_ml,
                            stats.category_esg,
                            stats.category_viz,
                            stats.category_others
                        ];
                        categoryChart.update();
                    }
                    
                    // 詳細統計の更新（MB単位）
                    const totalFiles = document.getElementById('chart-total-files');
                    const totalSize = document.getElementById('chart-total-size');
                    const avgSize = document.getElementById('chart-avg-size');
                    const lastUpdated = document.getElementById('chart-last-updated');
                    
                    if (totalFiles) totalFiles.textContent = stats.total_files;
                    if (totalSize) totalSize.textContent = totalSizeMB.toFixed(0);
                    if (avgSize) avgSize.textContent = 
                        stats.total_datasets > 0 ? (totalSizeMB / stats.total_datasets).toFixed(0) : '0';
                    
                    // 最終更新時刻
                    const lastUpdatedTime = new Date(stats.last_updated);
                    if (lastUpdated) lastUpdated.textContent = 
                        lastUpdatedTime.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
                    
                    const currentTime = new Date().toLocaleTimeString('ja-JP');
                    if (statusDiv) statusDiv.textContent = `最終更新: ${currentTime}`;
                } else {
                    if (statusDiv) statusDiv.textContent = 'データ取得エラー';
                }
                
            } catch (error) {
                console.error('Chart update error:', error);
                if (statusDiv) statusDiv.textContent = `エラー: ${error.message}`;
            }
        }

        // 手動更新
        function refreshCharts() {
            updateCharts();
        }

        // 自動更新の設定
        function setupAutoRefresh() {
            const checkbox = document.getElementById('auto-refresh-charts');
            
            function toggleAutoRefresh() {
                if (checkbox.checked) {
                    if (autoRefreshInterval) {
                        clearInterval(autoRefreshInterval);
                    }
                    autoRefreshInterval = setInterval(updateCharts, 30000); // 30秒ごと
                    document.getElementById('chart-status').textContent = '自動更新 ON (30秒間隔)';
                } else {
                    if (autoRefreshInterval) {
                        clearInterval(autoRefreshInterval);
                        autoRefreshInterval = null;
                    }
                    document.getElementById('chart-status').textContent = '自動更新 OFF';
                }
            }
            
            checkbox.addEventListener('change', toggleAutoRefresh);
            toggleAutoRefresh(); // 初期設定
        }

        // 初期化
        document.addEventListener('DOMContentLoaded', function() {
            updateSystemStatus();
            updateGoogleDriveStatus();
            
            // チャート初期化
            initializeCharts();
            updateCharts();
            setupAutoRefresh();
            
            // 更新ボタンのイベントリスナー
            const refreshBtn = document.getElementById('refresh-charts-btn');
            if (refreshBtn) {
                refreshBtn.addEventListener('click', refreshCharts);
            }
        });
    </script>
</body>
</html>